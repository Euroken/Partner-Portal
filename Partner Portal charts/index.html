<style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f8f9fa;
      padding: 20px;
    }

    .dashboard {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      width: 80%;
    }

    .target-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .target-label {
      font-size: 16px;
      color: black;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .target-amount {
      font-size: 48px;
      font-weight: 700;
      color: #2196F3;
      margin: 0;
    }

    .discount-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      justify-content: center;
    }

    .discount-card {
      background:  #0d49cd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      flex: 1;
      max-width: 320px;
      position: relative; /* Added for star positioning */
      /* overflow: hidden; /* Added to hide stars initially */
      cursor: pointer; /* Added to indicate interactivity */
    }

    .discount-card:first-child {
      background: #1562fe; 
    }
    .discount-card:nth-child {
      background: #1360fa;
    }

    .discount-label {
      font-size: 14px;
      color: white;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .discount-value {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .charts-container {
    display: flex;
    gap: 40px;
    align-items: flex-start; /* Ensures titles align horizontally */
    justify-content: center;
  }

    .main-chart-container {
      position: relative;
      flex: 2;
    }

    .chart-title {
      text-align: center;
      font-size: 16px;
      color: black;
      font-weight: 500;
      margin-bottom: 20px;
    }

    .chart-wrapper {
      position: relative;
      width: 600px;
      height: 250px;
      margin: 0 auto;
    }

    .center-amount {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #2196F3;
      z-index: 10;
    }

    .target-vs-achieved-header {
      margin-bottom: 30px;
    }

    .target-vs-achieved-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    /* Account Manager Contribution Styles */
    .account-manager-header {
      margin-bottom: 60px;
    }

    .account-manager-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .account-manager-container {
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .account-manager-chart {
      position: relative;
      width: 300px;
      height: 200px;
      flex: 2;
    }

    .account-manager-center {
      position: absolute;
      top: 75%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      font-weight: 700;
      color: #2196F3;
      z-index: 10;
    }

    .account-manager-legend {
      flex: 1;
    }

    .legend-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .legend-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }

    .themba-color {
      background-color: #2196F3;
    }

    .unknown-color {
      background-color: #666666;
    }

    .legend-item label {
      cursor: pointer;
      color: #333;
    }

    .history-header {
      margin-bottom: 60px;
    }

    .history-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .header-navbar {
      width: 80%;
      padding: 10px 20px;
      box-sizing: border-box;
      display: flex;
      justify-content: flex-start; /* Aligns content to the left */
      align-items: center;
      margin-bottom: 20px; /* Adds some space below the header */
    }

    .navbar-logo {
      height: 50px; /* Adjust the height as needed */

    }

    /* Star animation styles */
    .star-animation-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Allows clicks to pass through */
    }

    .star {
        position: absolute;
        color: #1f60ec; /* Relevant yellow color */
        font-size: 1rem;
        opacity: 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>

  <div class="dashboard">
    <div class="target-vs-achieved-header">
      <h2>Target VS Achieved</h2>
      <hr />
    </div>

    <div class="target-header">
      <div class="target-label">Target for the Year</div>
      <div class="target-amount" id="targetAmount">R 0.00</div>
    </div>

    <div class="discount-cards">
      <div class="discount-card">
        <div class="discount-label">Net New Logo Discount</div>
        <div class="discount-value" id="netNewLogoDiscount">0.00%</div>
        <div class="star-animation-container"></div>
      </div>
      <div class="discount-card">
        <div class="discount-label">New Business Discount</div>
        <div class="discount-value" id="newBusinessDiscount">0.00%</div>
        <div class="star-animation-container"></div>
      </div>
      <div class="discount-card">
        <div class="discount-label">Renewal Discount</div>
        <div class="discount-value" id="renewalDiscount">0.00%</div>
        <div class="star-animation-container"></div>
      </div>
    </div>

    <div class="charts-container">
      <div class="main-chart-container">
        <div class="chart-title">New Business Achieved</div>
        <div class="chart-wrapper">
          <canvas id="mainChart"></canvas>
          <div class="center-amount" id="achievedAmount">R 0.00</div>
        </div>
      </div>

    </div>
  </div>

  <div class="dashboard" style="margin-top: 30px;">
    <div class="account-manager-header">
      <h2>Account Manager Contribution</h2>
      <hr />
    </div>

    <div class="account-manager-container">
      <div class="account-manager-chart">
        <canvas id="accountManagerChart"></canvas>
        <div class="account-manager-center" id="accountManagerTotal">R 0.00M</div>
      </div>

      <div class="account-manager-legend">
        <div class="legend-title">Account Manager Name</div>
        <div class="legend-item">
          <input type="checkbox" id="themba" checked>
          <span class="legend-color themba-color"></span>
          <label for="themba">Themba Nkosi</label>
        </div>
        <div class="legend-item">
          <input type="checkbox" id="unknown" checked>
          <span class="legend-color unknown-color"></span>
          <label for="unknown">Unknown</label>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard" style="margin-top: 30px;">
    <div class="history-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h2>History (New Business)</h2>
      <div style="display: flex; gap: 10px;">
        <button id="toggleChartType" style="padding: 6px 16px; background-color: #1563FF; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
          Switch to Line Chart
        </button>
        <button id="toggleDataLabels" style="padding: 6px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
          Hide Data Labels
        </button>
      </div>
    </div>
      
    <div class="history-container">
        <div class="history-chart">
          <canvas id="historyChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script>

    //const user = window.logged_in_user;
    //const accId = user["ID"][0];
    //const accName = user["Account Name"][0];
    //const accType = user["Account Type"][0];
  
    const colors = ["#1563ff", "#1463fe", "#1562fe", "#1360fa", "#145ff8", "#135df4", "#125aed", "#1057e7", "#1053e0", "#0e4ed6", "#0d49cd", "#0943c0", "#063db2", "#0436a5", "#012b90"];

    let historyColors = [];
    let historyData = [44951.50, 408137.23, 1363455.09, 3539438.47];

    /**
     * Get the representative indices for datasetCount from a fixed-length color array
     * Handles both divisible and non-divisible divisions using remainder distribution
     *
     * @param {number} totalColors - Length of the color array (usually 15)
     * @param {number} datasetCount - Number of datasets (must be less than totalColors)
     * @returns {number[]} - Array of selected indices
     */
    function getColorIndicesWithSkips(totalColors, datasetCount) {
      if (datasetCount <= 0 || datasetCount > totalColors) {
        throw new Error("Invalid dataset count");
      }

      const baseChunkSize = Math.floor(totalColors / datasetCount);
      const remainder = totalColors % datasetCount;

      const indices = [];
      let currentIndex = 0;

      for (let i = 0; i < datasetCount; i++) {
        let chunkSize = baseChunkSize;

        // Distribute extra elements (from remainder) to first few chunks
        if (i < remainder) {
          chunkSize += 1;
        }

        const middleIndex = currentIndex + Math.floor(chunkSize / 2);
        indices.push(middleIndex);

        currentIndex += chunkSize;
      }

      return indices;
    }

    /**
     * Select representative colors for chart datasets using above logic
     *
     * @param {string[]} colorsArray - Array of 15 HEX or RGB colors
     * @param {number} datasetCount - Number of datasets
     * @returns {string[]} - Array of selected color values
     */
    function getRepresentativeColors(colorsArray, datasetCount) {
      const indices = getColorIndicesWithSkips(colorsArray.length, datasetCount);
      return indices.map(index => colorsArray[index]);
    }

    const selectedColors = getRepresentativeColors(colors, historyData.length);

    const targetAmount = 2000000.00;
    const achievedAmount = 3037053.97;
    const percentageAchieved = (achievedAmount / targetAmount * 100).toFixed(1);

    const speed = targetAmount < achievedAmount ? targetAmount/achievedAmount*100 : 100;
    let animationAngle = 0;
const pointer = {
  id: 'pointer',
  defaults: {
    percentage: 0,
    maxAngle: 0
  },
  afterDraw(chart, args, opt) {
    const { ctx } = chart;
    const data = chart._metasets[0].data[0];
    const radius = data.outerRadius;
    const centerX = data.x;
    const centerY = data.y;

    // ðŸ”„ Calculate current angle based on animation step
    const percentage = chart.options.plugins.pointer.percentage;
    const angleRad = Math.PI * (speed / 100) * percentage + Math.PI;
    const angleDeg = angleRad * (180 / Math.PI); // For conditional logic

    const pointerX = centerX + radius * Math.cos(angleRad);
    const pointerY = centerY + radius * Math.sin(angleRad);

    // 1ï¸âƒ£ Draw the white pointer
    ctx.save();
    ctx.beginPath();
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'white';
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(pointerX, pointerY);
    ctx.stroke();
    ctx.restore();

    // 2ï¸âƒ£ Draw the "Target" label dynamically positioned
    ctx.save();
    ctx.fillStyle = '#000';
    ctx.font = 'bold 14px sans-serif';

    // Logic for placing label based on angle
    let labelX = pointerX;
    let labelY = pointerY;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    //console.log(angleDeg);

    if (angleDeg > 270 && angleDeg <= 360) {
      // Right side
      labelX += 10;
      ctx.textAlign = 'left';
    } else if (angleDeg >= 180 && angleDeg < 271) {
      // Left side
      labelX -= 10;
      ctx.textAlign = 'right';
    } else {
      // Top
      labelY -= 60;
      ctx.textAlign = 'center';
    }

    ctx.fillText(`Target: R ${targetAmount.toLocaleString('en-ZA')}`, labelX, labelY);
    ctx.restore();

    // 3ï¸âƒ£ Draw the "R0" label always on the left side of chart
    ctx.save();
    ctx.fillStyle = '#000';
    ctx.font = 'bold 14px sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    ctx.fillText('R0', centerX - radius - 15, centerY-5);
    ctx.restore();
  }
};



    // Main semi-doughnut chart
    const ctx1 = document.getElementById('mainChart').getContext('2d');
    const gradient1 = ctx1.createLinearGradient(0, 0, 400, 250);
    gradient1.addColorStop(0, '#1563FF');
    gradient1.addColorStop(1, '#012B90');

    // For the main chart, we show the full achievement even if it exceeds target
    const mainChart = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['Achieved', 'Remaining'],
        datasets: [{
          data: [achievedAmount, Math.max(0, targetAmount - achievedAmount)],
          backgroundColor: [gradient1, '#e0e0e0'],
          borderWidth: 0,
          cutout: '70%'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,
        rotation: -90,
        animation:{
          onProgress: function(context){
              if(context.initial){
                  this.options.plugins.pointer.percentage = context.currentStep / context.numSteps;
              }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: true,
            displayColors: false,
            callbacks: {
              title: () => '', // Removes the default title
              label: (context) => {
                const label = context.label;
                if (label === 'Achieved') {
                  return [
                    `Target: R ${targetAmount.toLocaleString('en-ZA')}`,
                    `Achieved: R ${achievedAmount.toLocaleString('en-ZA')} (${percentageAchieved}%)`
                  ];
                }
                return `Remaining: R ${context.raw.toLocaleString('en-ZA')}`;
              }
            }
          },
          datalabels: {
  color: '#fff',
  font: {
    weight: 'bold',
    size: 14
  },
  formatter: (value, context) => {
    return context.dataIndex === 0 ? 'Achieved' : '';
  },
  anchor: 'center',
  align: 'center'
}
,
          pointer: {currentAngle: 1}
        }
      },
      plugins: [pointer, ChartDataLabels]

    });

    // Account Manager Contribution Chart
    const ctx3 = document.getElementById('accountManagerChart').getContext('2d');
    const gradient3 = ctx3.createLinearGradient(0, 0, 400, 300);
    gradient3.addColorStop(0, '#1563FF');
    gradient3.addColorStop(1, '#012B90');

    // Data for account manager contribution
    const thembaAmount = 2193489.11; // 54.20% of 3.07M
    const unknownAmount = 1345949.36; // 45.80% of 3.07M
    const totalAmount = thembaAmount + unknownAmount;

    const accountManagerChart = new Chart(ctx3, {
      type: 'doughnut',
      data: {
        labels: ['Themba Nkosi', 'Unknown'],
        datasets: [{
          data: [thembaAmount, unknownAmount],
          backgroundColor: [gradient3, '#b0b0b0'],
          borderWidth: 0,
          cutout: '60%'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,
        rotation: -90,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return `${label}: R ${value.toLocaleString('en-ZA')}`;
              }
            }
          },
          datalabels: {
            color: '#fff',
            font: {
              weight: 'bold',
              size: 14
            },
            formatter: (value, context) => {
              const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              if (value === 0) return ''; // Skip label if hidden
              const percentage = (value / total * 100).toFixed(2);
              return percentage + '%';
            }
          }
        },
      },
      plugins: [ChartDataLabels]
    });
    // History Chart
    let currentChartType = "bar";
  const ctx4 = document.getElementById('historyChart').getContext('2d');
  const historyDataConfig = {
    type: currentChartType,
    data: {
      labels: ["2022", "2023", "2024", "2025"],
      datasets: [{
        label: "New Business",
        data: historyData,
        backgroundColor: selectedColors,
        borderColor: "#1563FF",
        fill: currentChartType === "line" ? false : true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        datalabels: {
          display: true,
          color: '#fff',
          font: {
            weight: 'bold',
            size: 14
          },
          formatter: (value) => `R${value.toLocaleString('en-ZA')}`
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              return `R ${value.toLocaleString('en-ZA')}`;
            }
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  };

let historyChart = new Chart(ctx4, historyDataConfig);

document.getElementById('toggleChartType').addEventListener('click', () => {
  historyChart.destroy();
  currentChartType = currentChartType === "bar" ? "line" : "bar";

  // Update button text
  document.getElementById('toggleChartType').textContent =
    currentChartType === "bar" ? "Switch to Line Chart" : "Switch to Bar Chart";

  // Update chart config type
  historyDataConfig.type = currentChartType;

  // Adjust chart visuals based on type
  if (currentChartType === "bar") {
    historyDataConfig.data.datasets[0].backgroundColor = selectedColors; // multiple bars
    historyDataConfig.data.datasets[0].borderColor = "#1563FF"; // Optional
    historyDataConfig.data.datasets[0].fill = true;
    historyDataConfig.options.plugins.datalabels.color = '#fff';
  } else {
    const lightBlue = '#ADD8E6';
    historyDataConfig.data.datasets[0].backgroundColor = lightBlue;
    historyDataConfig.data.datasets[0].borderColor = lightBlue;
    historyDataConfig.data.datasets[0].fill = false;
    historyDataConfig.options.plugins.datalabels.color = '#000';
  }

  // Re-render chart
  historyChart = new Chart(ctx4, historyDataConfig);
});

let datalabelsVisible = true;

document.getElementById('toggleDataLabels').addEventListener('click', () => {
  datalabelsVisible = !datalabelsVisible;

  // Toggle visibility in config
  historyDataConfig.options.plugins.datalabels.display = datalabelsVisible;

  // Update button label
  document.getElementById('toggleDataLabels').textContent = datalabelsVisible ? "Hide Data Labels" : "Show Data Labels";

  // Recreate chart to apply change
  historyChart.destroy();
  historyChart = new Chart(ctx4, historyDataConfig);
});

    // Handle legend checkboxes
    document.getElementById('themba').addEventListener('change', function() {
      const dataset = accountManagerChart.data.datasets[0];
      if (this.checked) {
        dataset.data[0] = thembaAmount;
      } else {
        dataset.data[0] = 0;
      }
      accountManagerChart.update();
    });

    document.getElementById('unknown').addEventListener('change', function() {
      const dataset = accountManagerChart.data.datasets[0];
      if (this.checked) {
        dataset.data[1] = unknownAmount;
      } else {
        dataset.data[1] = 0;
      }
      accountManagerChart.update();
    });

    // Anime.js counter animations
    function animateCounter(elementId, startValue, endValue, duration, prefix, suffix, isMoney = false, isMillions = false) {
        const element = document.getElementById(elementId);
        anime({
            targets: { value: startValue },
            value: endValue,
            round: false,
            duration: duration,
            easing: 'easeInOutQuad',
            update: function(anim) {
                let value = anim.animations[0].currentValue;
                if (isMoney) {
                    element.innerHTML = `${prefix}${value.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else if (isMillions) {
                    element.innerHTML = `${prefix}${value.toFixed(2)}${suffix}`;
                }
                else {
                    element.innerHTML = `${value.toFixed(2)}${suffix}`;
                }
            }
        });
    }

    animateCounter('targetAmount', 0, targetAmount, 1500, 'R ', '', true);
    animateCounter('netNewLogoDiscount', 0, 12.50, 1000, '', '%');
    animateCounter('newBusinessDiscount', 0, 10.00, 1000, '', '%');
    animateCounter('renewalDiscount', 0, 5.00, 1000, '', '%');
    animateCounter('achievedAmount', 0, achievedAmount, 1500, 'R ', '', true);
    animateCounter('accountManagerTotal', 0, 3.54, 1500, 'R ', 'M', false, true);

    // Star animation logic
    const discountCards = document.querySelectorAll('.discount-card');

    discountCards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            const container = card.querySelector('.star-animation-container');
            createStars(container);
        });

        card.addEventListener('click', (e) => {
             // Prevents the animation from re-triggering on click if already triggered by hover
             // e.stopPropagation();
            const container = card.querySelector('.star-animation-container');
            createStars(container);
        });
    });

    function createStars(container) {
        const starCount = 5;
        const starSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;

        // Remove any existing stars to prevent them from stacking
        container.innerHTML = '';

        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.innerHTML = starSVG;
            star.classList.add('star');
            star.style.left = `${Math.random() * 100}%`;
            star.style.fontSize = `${Math.random() * 0.5 + 0.8}rem`;
            container.appendChild(star);

            anime({
                targets: star,
                translateY: [
                    { value: `${-50 - Math.random() * 50}px`, duration: 500 }, // Pop up
                    { value: `150px`, duration: 1000, easing: 'easeInSine' }  // Fall down and disappear
                ],
                scale: [
                    { value: [0, 1], duration: 200 }, // Fade in and scale up
                    { value: 0, delay: 1000, duration: 500 } // Fade out
                ],
                rotate: `${Math.random() * 360}deg`,
                opacity: [
                    { value: 1, duration: 200 },
                    { value: 0, delay: 1000, duration: 500 }
                ],
                easing: 'easeInOutQuad',
                duration: 1500,
                delay: i * 50, // Stagger the stars
                complete: () => {
                    star.remove();
                }
            });
        }
    }

    // This is important for Lucide icons to render properly after being added to the DOM
    window.onload = function () {
      lucide.createIcons();
    };

    document.addEventListener('DOMContentLoaded', async () => {
        // You should use the actual user data from the window object
        //const user = window.logged_in_user;
        const accId = "3531584000068785003"; //
        const accName = "Nkemba Technologies (Pty) Ltd" //

        // Your backend function's URL
        const functionUrl = 'https://certificateanalyzer-893656151.development.catalystserverless.com/server/get-channel/api/fetchAnalyticsData';
        
        // ðŸ’¡ Pass accId and accName as URL query parameters
        const urlWithParams = `${functionUrl}?accId=${encodeURIComponent(accId)}&accName=${encodeURIComponent(accName)}`;

        console.log(`Attempting to fetch data for Account ID: ${accId} and Account Name: ${accName}`);

        try {
            // ðŸ’¡ Change the request to a GET method
            const response = await fetch(urlWithParams, {
                method: 'GET'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Server responded with status: ${response.status}. Message: ${errorData.message}`);
            }

            const data = await response.json();
            console.log('Successfully fetched data from Catalyst function:', data);

            // You can now use the 'data' object to update your frontend UI
            // Example: updateDashboard(data);

        } catch (error) {
            console.error('Error fetching analytics data:', error);
        }
    });

  </script>